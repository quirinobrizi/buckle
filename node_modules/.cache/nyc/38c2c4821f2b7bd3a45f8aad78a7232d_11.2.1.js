/*******************************************************************************
 * Copyright [2017] [Quirino Brizi (quirino.brizi@gmail.com)]
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not
 * use this file except in compliance with the License. You may obtain a copy of
 * the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/'use strict';var cov_ctvq9nsez=function(){var path='/home/quirino/Projects/buckle/src/application/EnvironmentService.js',hash='7292cec52ede7fc9755071135f7b50b6ba7b42e2',global=new Function('return this')(),gcv='__coverage__',coverageData={path:'/home/quirino/Projects/buckle/src/application/EnvironmentService.js',statementMap:{'0':{start:{line:19,column:15},end:{line:19,column:50}},'1':{start:{line:24,column:0},end:{line:76,column:2}},'2':{start:{line:27,column:8},end:{line:27,column:41}},'3':{start:{line:28,column:8},end:{line:28,column:45}},'4':{start:{line:29,column:8},end:{line:29,column:59}},'5':{start:{line:31,column:8},end:{line:31,column:29}},'6':{start:{line:35,column:8},end:{line:35,column:110}},'7':{start:{line:36,column:8},end:{line:36,column:59}},'8':{start:{line:40,column:8},end:{line:40,column:61}},'9':{start:{line:48,column:19},end:{line:48,column:23}},'10':{start:{line:51,column:12},end:{line:55,column:13}},'11':{start:{line:52,column:16},end:{line:54,column:31}},'12':{start:{line:53,column:20},end:{line:53,column:61}},'13':{start:{line:57,column:22},end:{line:57,column:79}},'14':{start:{line:59,column:8},end:{line:62,column:9}},'15':{start:{line:60,column:25},end:{line:60,column:35}},'16':{start:{line:61,column:12},end:{line:61,column:43}},'17':{start:{line:71,column:26},end:{line:71,column:64}},'18':{start:{line:72,column:25},end:{line:72,column:102}},'19':{start:{line:73,column:8},end:{line:73,column:65}},'20':{start:{line:74,column:8},end:{line:74,column:59}}},fnMap:{'0':{name:'(anonymous_0)',decl:{start:{line:26,column:4},end:{line:26,column:5}},loc:{start:{line:26,column:69},end:{line:32,column:5}},line:26},'1':{name:'(anonymous_1)',decl:{start:{line:34,column:4},end:{line:34,column:5}},loc:{start:{line:34,column:35},end:{line:37,column:5}},line:34},'2':{name:'(anonymous_2)',decl:{start:{line:39,column:4},end:{line:39,column:5}},loc:{start:{line:39,column:31},end:{line:41,column:5}},line:39},'3':{name:'(anonymous_3)',decl:{start:{line:43,column:4},end:{line:43,column:5}},loc:{start:{line:43,column:12},end:{line:45,column:5}},line:43},'4':{name:'(anonymous_4)',decl:{start:{line:47,column:4},end:{line:47,column:5}},loc:{start:{line:47,column:30},end:{line:63,column:5}},line:47},'5':{name:'comparer',decl:{start:{line:50,column:17},end:{line:50,column:25}},loc:{start:{line:50,column:38},end:{line:56,column:9}},line:50},'6':{name:'(anonymous_6)',decl:{start:{line:51,column:19},end:{line:51,column:20}},loc:{start:{line:51,column:37},end:{line:55,column:13}},line:51},'7':{name:'(anonymous_7)',decl:{start:{line:52,column:41},end:{line:52,column:42}},loc:{start:{line:52,column:57},end:{line:54,column:17}},line:52},'8':{name:'(anonymous_8)',decl:{start:{line:70,column:4},end:{line:70,column:5}},loc:{start:{line:70,column:43},end:{line:75,column:5}},line:70}},branchMap:{},s:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0,'13':0,'14':0,'15':0,'16':0,'17':0,'18':0,'19':0,'20':0},f:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0},b:{},_coverageSchema:'332fd63041d2c1bcb487cc26dd0d5f7d97098a6c'},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();const logger=(cov_ctvq9nsez.s[0]++,require('../infrastructure/Logger'));/**
 * Manage services for containers realization.
 */cov_ctvq9nsez.s[1]++;module.exports=class EnvironmentService{constructor(eventEmitter,anomalyService,environmentRepository){cov_ctvq9nsez.f[0]++;cov_ctvq9nsez.s[2]++;this.eventEmitter=eventEmitter;cov_ctvq9nsez.s[3]++;this.anomalyService=anomalyService;cov_ctvq9nsez.s[4]++;this.environmentRepository=environmentRepository;cov_ctvq9nsez.s[5]++;this.containers={};}deregisterContainer(container){cov_ctvq9nsez.f[1]++;cov_ctvq9nsez.s[6]++;logger.info("* * remove [%s] [%s] from realization",container.getName(),container.getContainerId());cov_ctvq9nsez.s[7]++;delete this.containers[container.getContainerId()];}alreadyObserves(container){cov_ctvq9nsez.f[2]++;cov_ctvq9nsez.s[8]++;return container.getContainerId()in this.containers;}close(){cov_ctvq9nsez.f[3]++;}removeOrphans(containers){cov_ctvq9nsez.f[4]++;var self=(cov_ctvq9nsez.s[9]++,this);function comparer(otherArray){cov_ctvq9nsez.f[5]++;cov_ctvq9nsez.s[10]++;return function(current){cov_ctvq9nsez.f[6]++;cov_ctvq9nsez.s[11]++;return otherArray.filter(function(other){cov_ctvq9nsez.f[7]++;cov_ctvq9nsez.s[12]++;return other.getContainerId()==current;}).length==0;};}var orphans=(cov_ctvq9nsez.s[13]++,Object.keys(self.containers).filter(comparer(containers)));cov_ctvq9nsez.s[14]++;for(var i=0;i<orphans.length;i++){var orphan=(cov_ctvq9nsez.s[15]++,orphans[i]);cov_ctvq9nsez.s[16]++;delete self.containers[orphan];}}/**
     * Evaluate the received realization
     * @method evaluateRealization
     * @param  {Realization}            realization the received realization
     */async evaluateRealization(realization){cov_ctvq9nsez.f[8]++;let environment=(cov_ctvq9nsez.s[17]++,await this.environmentRepository.get());let containers=(cov_ctvq9nsez.s[18]++,environment.inspectRealizationsForAnomalies(realization,this.anomalyService));cov_ctvq9nsez.s[19]++;this.eventEmitter.emit('containers.updated',containers);cov_ctvq9nsez.s[20]++;this.containers[realization.getContainerId()]={};}};